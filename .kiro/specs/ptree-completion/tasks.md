# Implementation Plan

- [x] 1. Extend NAME_TYPE Registry with NUMERAL and index-type
  - [x] 1.1 Add NUMERAL NAME_TYPE definition to ptree.default-config.json
    - Add pattern `^[IVXLCDM]+$` with examples I, II, III, IV, V, X, L, C, D, M
    - Set word_delimiter to null, allowed_version_delimiters to ["-", "_"]
    - _Requirements: 1.1, 4.5_
  - [x] 1.2 Add index-type NAME_TYPE definition to ptree.default-config.json
    - Add pattern for `(index)` prefix files
    - _Requirements: 3.2_
  - [x] 1.3 Add NUMERAL to ENTITY_NAME_TYPES in both config files
    - Add NUMERAL array with ["NUMERAL"] as allowed type
    - _Requirements: 1.2, 4.2_
  - [x] 1.4 Update ptree.spec-config.json with same NAME_TYPE additions
    - Mirror changes from default config
    - _Requirements: 1.2_
  - [x] 1.5 Write property test for NAME_TYPE pattern-example consistency
    - **Property 2: NAME_TYPE Pattern-Example Consistency**
    - **Validates: Requirements 1.2**

- [x] 2. Implement Roman Numeral Parser
  - [x] 2.1 Create parseNumeralPrefix function in parser.ts
    - Parse `[NUMERAL]_[remainder]` pattern from directory names
    - Return { numeral: string | null, remainder: string }
    - _Requirements: 4.1, 4.3_
  - [x] 2.2 Create isValidRomanNumeral validation function
    - Validate Roman numeral format (I-M, values 1-1000)
    - Use regex: `^M{0,3}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3})$`
    - _Requirements: 4.5_
  - [x] 2.3 Extend PtreeNode type with numeralPrefix field
    - Add optional numeralPrefix: string field
    - Populate during parsing when NUMERAL pattern detected
    - _Requirements: 4.1_
  - [x] 2.4 Write property test for Roman numeral validation
    - **Property 6: Roman Numeral Validation**
    - **Validates: Requirements 4.5**

- [x] 3. Implement Index File Recognition
  - [x] 3.1 Create parseIndexFile function in parser.ts
    - Parse `(index)` prefix pattern
    - Return { isIndex: boolean, remainder: string }
    - _Requirements: 3.2_
  - [x] 3.2 Extend PtreeNode type with isIndexFile field
    - Add optional isIndexFile: boolean field
    - Populate during parsing when (index) prefix detected
    - _Requirements: 3.2_
  - [x] 3.3 Update validator to allow (index) prefix in FILE names
    - Skip NAME_TYPE validation for (index) prefix portion
    - Validate remainder against FILE NAME_TYPE rules
    - _Requirements: 3.5_
  - [x] 3.4 Write property test for index file recognition
    - **Property 12: Index File Recognition**
    - **Validates: Requirements 3.2, 3.5**

- [x] 4. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 5. Implement EXT Entity Support
  - [x] 5.1 Create splitFileExtension function in parser.ts
    - Split file name into stem and extension(s)
    - Support both firstDot and lastDot strategies
    - Handle dotfiles correctly
    - _Requirements: 2.1, 2.4_
  - [x] 5.2 Extend PtreeNode type with stem and extension fields
    - Add optional stem: string and extension: string fields
    - Populate during parsing for FILE entities
    - _Requirements: 2.1_
  - [x] 5.3 Add EXT to ENTITY_NAME_TYPES in config files
    - Default to ["smol-type"] for extension validation
    - _Requirements: 2.2, 2.5_
  - [x] 5.4 Update validator to validate extensions against EXT NAME_TYPE
    - Check each extension segment against allowed EXT NAME_TYPEs
    - Report PT007 for uppercase extensions
    - _Requirements: 2.2, 2.3, 2.4_
  - [x] 5.5 Write property test for extension parsing consistency
    - **Property 7: Extension Parsing Consistency**
    - **Validates: Requirements 2.1, 2.4**

- [x] 6. Implement META Entity Enhancements
  - [x] 6.1 Update classifyNode function to properly handle META entities
    - Classify nodes ending with `//` as META
    - _Requirements: 3.1_
  - [x] 6.2 Update validator to validate META nodes against META NAME_TYPE
    - Apply META NAME_TYPE rules from config
    - _Requirements: 3.3_
  - [x] 6.3 Write property test for entity classification determinism
    - **Property 5: Entity Classification Determinism**
    - **Validates: Requirements 2.1, 3.1**

- [x] 7. Implement UniRule Validators
  - [x] 7.1 Implement validateUniRule1 function in validator.ts
    - Check that version delimiter differs from word delimiter
    - Report PT005 for violations
    - _Requirements: 6.1, 6.2, 6.3, 6.4_
  - [x] 7.2 Enhance validateUniRule5 (PT008) implementation
    - Ensure no mixing of `-` and `_` in bare names
    - _Requirements: 6.5_
  - [x] 7.3 Write property test for UniRule_1 delimiter conflict detection
    - **Property 3: UniRule_1 Delimiter Conflict Detection**
    - **Validates: Requirements 6.1, 6.2, 6.4**
  - [x] 7.4 Write property test for UniRule_5 mixed delimiter detection
    - **Property 4: UniRule_5 Mixed Delimiter Detection**
    - **Validates: Requirements 6.5**

- [x] 8. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 9. Implement Parser Round-Trip Support
  - [x] 9.1 Extend PtreeDirective type with position fields
    - Add keyStartCol, keyEndCol, valueStartCol, valueEndCol, separatorChar
    - _Requirements: 7.2_
  - [x] 9.2 Create printPtreeDocument function in parser.ts
    - Serialize AST back to text preserving original formatting
    - _Requirements: 7.1, 7.3_
  - [x] 9.3 Update parser to preserve whitespace and comment positions
    - Store blank lines and comments in AST
    - _Requirements: 7.2_
  - [x] 9.4 Write property test for parser round-trip consistency
    - **Property 1: Parser Round-Trip Consistency**
    - **Validates: Requirements 7.1, 7.3**

- [x] 10. Implement PT009 Sorting Enhancements
  - [x] 10.1 Update fixer to reorder nodes when PT009 is enabled
    - Sort directories first, then files, each group alphabetically
    - _Requirements: 8.3_
  - [x] 10.2 Update formatter to apply PT009 sorting by default
    - Ensure formatter produces sorted output
    - _Requirements: 8.4_
  - [x] 10.3 Write property test for sorting transitivity
    - **Property 9: Sorting Transitivity (PT009)**
    - **Validates: Requirements 8.1, 8.2**
  - [x] 10.4 Write property test for fixer idempotence
    - **Property 8: Fixer Idempotence**
    - **Validates: Requirements 8.3**

- [x] 11. Implement Error Recovery Enhancements
  - [x] 11.1 Update parser to continue after invalid lines
    - Collect errors but don't stop parsing
    - _Requirements: 9.1_
  - [x] 11.2 Update parser to report unclosed bracket blocks with opening line
    - Track bracket depth and report error at opening line
    - _Requirements: 9.2_
  - [x] 11.3 Update validator to emit info-level for unknown directives
    - Don't block validation for unknown directives
    - _Requirements: 9.3_
  - [x] 11.4 Update config loader to report JSON parse errors with position
    - Include file path and line/column in error message
    - _Requirements: 9.4_

- [x] 12. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 13. Update Semantic Tokens for New Entities
  - [x] 13.1 Add ptreeNumeral semantic token type
    - Emit for Roman numeral prefixes in directory names
    - _Requirements: 13.1_
  - [x] 13.2 Update ptreeExtension token to include NAME_TYPE modifier
    - Apply nt_smol_type or configured EXT NAME_TYPE modifier
    - _Requirements: 13.2_
  - [x] 13.3 Add semantic token for index file prefix
    - Emit distinct token for `(index)` portion
    - _Requirements: 13.4_
  - [x] 13.4 Update TextMate grammar for new patterns
    - Add NUMERAL prefix highlighting
    - Add index file prefix highlighting
    - _Requirements: 13.1, 13.4_

- [x] 14. Implement CLI Enhancements
  - [x] 14.1 Add --format json option to validate command
    - Output JSON with file, line, column, code, severity, message
    - _Requirements: 11.1_
  - [x] 14.2 Add --diff option to validate command
    - Show unified diff of proposed fixes without applying
    - _Requirements: 11.2_
  - [x] 14.3 Update gen command to respect @name_type directive
    - Apply configured naming conventions to generated output
    - _Requirements: 11.3_

- [x] 15. Update Configuration Schema
  - [x] 15.1 Update ptreeconfig.schema.json with EXT and NUMERAL entities
    - Add EXT and NUMERAL to ENTITY_NAME_TYPES schema
    - _Requirements: 12.1_
  - [x] 15.2 Add validation for unknown NAME_TYPE references
    - Report error when config references undefined NAME_TYPE
    - _Requirements: 12.2_
  - [x] 15.3 Add validation for invalid rule settings
    - Report which rule and what is invalid
    - _Requirements: 12.3_
  - [x] 15.4 Write property test for config merge associativity
    - **Property 11: Config Merge Associativity**
    - **Validates: Requirements 1.4**

- [x] 16. Update Documentation
  - [x] 16.1 Update GRAMMAR.md with NUMERAL and index-type definitions
    - Document patterns, examples, and UniRules
    - _Requirements: 10.2, 10.6, 10.7_
  - [x] 16.2 Complete SEMANTIC_TOKENS.md documentation
    - Document all token types, modifiers, and theme customization
    - Add ptreeNumeral, ptreeIndex, ptreeSymlink token documentation
    - _Requirements: 10.1, 13.5, 13.6_
  - [x] 16.3 Update FUTURE_PLANS.md with roadmap
    - Add prioritized list of planned features
    - _Requirements: 10.3_
  - [x] 16.4 Create CONTRIBUTING.md with development guidelines
    - Include setup, testing, and PR guidelines
    - _Requirements: 10.4_
  - [x] 16.5 Update SPEC.md canonical header example
    - Add EXT, META, NUMERAL to @name_type block example
    - Document symlink syntax and inline metadata
    - _Requirements: 10.5_
  - [x] 16.6 Document all six UniRules in GRAMMAR.md
    - Ensure UR1-UR6 are fully documented with examples
    - _Requirements: 10.8_

- [x] 17. Update Samples and Examples
  - [x] 17.1 Update samples/example.ptree with generic content
    - Replace project-specific names with placeholders
    - Ensure it demonstrates all core features
    - _Requirements: 14.1, 14.2_
  - [x] 17.2 Add NUMERAL example to samples
    - Show Roman numeral prefixed directories (I_Introduction/, II_Content/)
    - _Requirements: 14.3_
  - [x] 17.3 Add META node examples to samples
    - Show proper `//` suffix usage
    - _Requirements: 14.4_
  - [x] 17.4 Add index file examples to samples
    - Show `(index)` prefix convention
    - _Requirements: 14.2_
  - [x] 17.5 Add symlink example to samples
    - Show ` -> ` arrow syntax with directory target
    - _Requirements: 16.3_
  - [x] 17.6 Add inline metadata examples to samples
    - Show bracket attributes `[key=value]` and inline comments `# comment`
    - _Requirements: 17.3_
  - [x] 17.7 Add summary line example to samples
    - Show `N directories, M files` format
    - _Requirements: 18.3_

- [x] 18. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 19. Write remaining property tests
  - [x] 19.1 Write property test for validator determinism
    - **Property 10: Validator Determinism**
    - **Validates: Requirements 1.5**

- [x] 20. Implement Symlink Support
  - [x] 20.1 Update parser to recognize symlink syntax
    - Parse ` -> ` arrow syntax to extract name and target
    - _Requirements: 16.1_
  - [x] 20.2 Extend PtreeNode type with symlinkTarget field
    - Add optional symlinkTarget: string field
    - _Requirements: 16.1_
  - [x] 20.3 Update validator to validate symlink names
    - Validate name portion against appropriate NAME_TYPE rules
    - _Requirements: 16.2_
  - [x] 20.4 Add semantic tokens for symlink components
    - Emit distinct tokens for name, arrow, and target
    - _Requirements: 16.3, 13.5_

- [x] 21. Implement Inline Metadata Support
  - [x] 21.1 Update parser to recognize bracket attributes
    - Parse `[key=value, key2=value2]` after two+ spaces
    - _Requirements: 17.1_
  - [x] 21.2 Update parser to recognize inline comments
    - Parse `# comment` after two+ spaces
    - _Requirements: 17.2_
  - [x] 21.3 Add semantic tokens for inline metadata
    - Emit distinct tokens for attributes and comments
    - _Requirements: 17.3, 13.6_
  - [x] 21.4 Update validator to exclude metadata from name validation
    - Validate only the name portion against NAME_TYPE rules
    - _Requirements: 17.4_

- [x] 22. Implement Summary Line Support
  - [x] 22.1 Update parser to recognize summary lines
    - Match pattern `N directories, M files`
    - _Requirements: 18.1_
  - [x] 22.2 Treat summary lines as metadata
    - Don't affect tree structure
    - _Requirements: 18.2_
  - [x] 22.3 Add semantic token for summary lines
    - Emit ptreeMeta token type
    - _Requirements: 18.3_

- [x] 23. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
